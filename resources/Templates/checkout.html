{% include 'partials/header.html' with {'seo' : seo } %}

<!-- checkout section -->
<section class="full_page checkout_section layout_padding">
  <div class="container">
    <div class="heading_container heading_center">
      <h1>
        <span style="color:#16a34a;"><i class="fa fa-shopping-cart"></i></span> Complete Your <span>Purchase</span>
      </h1>
      <p>
        Get instant access to <strong>Budget Control Pro</strong> and unlock all premium features.
      </p>
    </div>
    
    <div class="row margin-top-45">
      <div class="col-lg-8 col-md-12">
        <div class="checkout_form card border-radius shadow p-4 mb-4 bg-white">
          <div id="checkout-messages" class="mb-3"></div>
          
          <!-- Order Summary -->
          <div class="order-summary mb-4">
            <h4 class="mb-3" style="color: #16a34a;"><i class="fa fa-file-invoice-dollar"></i> Order Summary</h4>
            <div class="summary-item d-flex align-items-center justify-content-between p-3 rounded bg-light mb-2 border">
              <div class="item-details">
                <h5 class="mb-1 font-weight-bold">Budget Control Pro License</h5>
                <span class="badge bg-success mb-2 px-3 py-1" style="color: white;">Lifetime Access</span>
                <ul class="features-list list-unstyled mb-0">
                  <li><i class="fa fa-check" style="color: #16a34a;"></i> Unlimited accounts</li>
                  <li><i class="fa fa-check" style="color: #16a34a;"></i> Unlimited workspaces</li>
                  <li><i class="fa fa-check" style="color: #16a34a;"></i> Advanced analytics</li>
                  <li><i class="fa fa-check" style="color: #16a34a;"></i> Priority support</li>
                  <li><i class="fa fa-check" style="color: #16a34a;"></i> API access</li>
                </ul>
              </div>
              <div class="item-price text-right">
                <span class="price badge px-3 py-2" style="font-size:1.5em; background-color: #059669; color: white;">€{{ price }}</span>
              </div>
            </div>
            <hr>
            <div class="summary-total text-right">
              <strong class="badge px-3 py-2" style="font-size:1.2em; background-color: #16a34a; color: white;">Total: €{{ price }}</strong>
            </div>
          </div>
          
          <!-- Payment Form -->
          <form id="checkout-form" method="POST" action="/checkout/process" class="contact-form">
            <input type="hidden" name="product_id" value="budget-control-pro">
            <input type="hidden" name="price" value="{{ price }}">
            
            <div class="section-title mt-4 mb-2">
              <h4 style="color: #059669;"><i class="fa fa-user"></i> Billing Information</h4>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="first_name">First Name *</label>
                  <input type="text" class="form-control" id="first_name" name="first_name" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="last_name">Last Name *</label>
                  <input type="text" class="form-control" id="last_name" name="last_name" required>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label for="company">Company <span class="text-muted">(Optional)</span></label>
              <input type="text" class="form-control" id="company" name="company">
            </div>
            
            <div class="row">
              <div class="col-md-8">
                <div class="form-group">
                  <label for="address">Address *</label>
                  <input type="text" class="form-control" id="address" name="address" required>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="postal_code">Postal Code *</label>
                  <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="city">City *</label>
                  <input type="text" class="form-control" id="city" name="city" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="country">Country *</label>
                  <select class="form-control" id="country" name="country" required>
                    <option value="">Select Country</option>
                    <option value="IT">Italy</option>
                    <option value="US">United States</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="ES">Spain</option>
                    <option value="GB">United Kingdom</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="section-title mt-4 mb-2">
              <h4 style="color: #059669;"><i class="fa fa-credit-card"></i> Payment Method</h4>
            </div>
            
            <div class="payment-methods mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="payment_method" id="stripe" value="stripe" checked>
                <label class="form-check-label" for="stripe">
                  <i class="fab fa-cc-stripe fa-lg"></i> Credit Card (Stripe)
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="payment_method" id="paypal" value="paypal">
                <label class="form-check-label" for="paypal">
                  <i class="fab fa-paypal fa-lg"></i> PayPal
                </label>
              </div>
            </div>
            
            <!-- Stripe Card Element -->
            <div id="stripe-card-element" class="payment-element mb-3">
              <div class="form-group">
                <label>Card Information</label>
                <div id="card-element" class="form-control" style="padding: 10px; min-height: 40px;"></div>
                <div id="card-errors" role="alert" class="text-danger small-text mt-2"></div>
              </div>
            </div>
            
            <!-- PayPal Element -->
            <div id="paypal-element" class="payment-element" style="display: none;">
              <div id="paypal-button-container"></div>
            </div>
            
            <div class="form-group form-check mt-3">
              <input type="checkbox" class="form-check-input" id="terms" name="terms" required>
              <label class="form-check-label" for="terms">
                I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a> *
              </label>
            </div>
            
            <div class="btn_box mt-4">
              <button type="submit" class="btn btn-purchase" id="submit-btn" style="font-size:1.2em;">
                <span class="btn-text"><i class="fa fa-lock"></i> Complete Purchase - €{{ price }}</span>
                <span class="btn-loading" style="display: none;">
                  <i class="fa fa-spinner fa-spin"></i> Processing...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="col-lg-4 col-md-12">
        <div class="checkout-sidebar">
          <div class="security-badges card border-radius p-3 mb-3 bg-light text-center">
            <h5 class="mb-2"><i class="fa fa-shield-alt" style="color: #16a34a;"></i> Secure Payment</h5>
            <div class="badges mb-2">
              <i class="fa fa-lock fa-lg" style="color: #059669;"></i>
              <span class="ml-2">256-bit SSL encryption</span>
            </div>
            <div class="badges mb-2">
              <i class="fa fa-credit-card fa-lg" style="color: #059669;"></i>
              <span class="ml-2">PCI DSS compliant</span>
            </div>
          </div>
          
          <div class="money-back-guarantee card border-radius p-3 mb-3 bg-light text-center">
            <h5 class="mb-2"><i class="fa fa-undo" style="color: #16a34a;"></i> 30-Day Money Back Guarantee</h5>
            <p class="mb-0">Not satisfied? Get a full refund within 30 days, no questions asked.</p>
          </div>
          
          <div class="instant-access card border-radius p-3 bg-light text-center">
            <h5 class="mb-2"><i class="fa fa-bolt" style="color: #16a34a;"></i> Instant Access</h5>
            <p class="mb-0">Get immediate access to all pro features after successful payment.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
// Stripe integration
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();

const cardElement = elements.create('card');
cardElement.mount('#card-element');

// Payment method toggle
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const stripeElement = document.getElementById('stripe-card-element');
        const paypalElement = document.getElementById('paypal-element');
        
        if (this.value === 'stripe') {
            stripeElement.style.display = 'block';
            paypalElement.style.display = 'none';
        } else if (this.value === 'paypal') {
            stripeElement.style.display = 'none';
            paypalElement.style.display = 'block';
        }
    });
});

// Form submission
document.getElementById('checkout-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const messagesDiv = document.getElementById('checkout-messages');
    
    // Show loading state
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    messagesDiv.innerHTML = '';
    
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    if (paymentMethod === 'stripe') {
        await handleStripePayment();
    } else if (paymentMethod === 'paypal') {
        await handlePayPalPayment();
    }
});
async function handleStripePayment() {
    const formData = new FormData(document.getElementById('checkout-form'));
    
    try {
        const response = await fetch('/checkout/create-payment-intent', {
            method: 'POST',
            body: formData
        });
        
        const { client_secret } = await response.json();
        
        const { error } = await stripe.confirmCardPayment(client_secret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: formData.get('first_name') + ' ' + formData.get('last_name'),
                    email: formData.get('email'),
                    address: {
                        line1: formData.get('address'),
                        city: formData.get('city'),
                        postal_code: formData.get('postal_code'),
                        country: formData.get('country')
                    }
                }
            }
        });
        
        if (error) {
            showError(error.message);
        } else {
            // Payment succeeded, redirect to success page
            window.location.href = '/checkout/success';
        }
    } catch (error) {
        showError('Payment failed. Please try again.');
    }
    
    resetButton();
}

function showError(message) {
    document.getElementById('checkout-messages').innerHTML = 
        '<div class="alert alert-danger">' + message + '</div>';
}

function resetButton() {
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    submitBtn.disabled = false;
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
}
</script>

<!-- end checkout section -->

{% include 'partials/footer.html' %}
